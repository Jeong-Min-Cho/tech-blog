---
import BaseLayout from './BaseLayout.astro';
import { formatDate, formatDateISO } from '@utils/formatDate';
import { getReadingTime } from '@utils/readingTime';
import TableOfContents from '@components/TableOfContents.astro';
import CodeCopy from '@components/CodeCopy.astro';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  tags?: string[];
  body: string;
  headings: { depth: number; slug: string; text: string }[];
  slug: string;
  prevPost?: { slug: string; title: string } | null;
  nextPost?: { slug: string; title: string } | null;
}

const { title, description, pubDate, updatedDate, heroImage, tags = [], body, headings, slug, prevPost, nextPost } = Astro.props;
const readingTime = getReadingTime(body);
---

<BaseLayout
  title={title}
  description={description}
  image={heroImage}
  article={{ publishedTime: formatDateISO(pubDate), modifiedTime: updatedDate ? formatDateISO(updatedDate) : undefined, tags }}
>
  <article class="mx-auto max-w-3xl px-4 py-12">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-skin-base mb-4">{title}</h1>
      <div class="flex flex-wrap items-center gap-4 text-sm text-skin-muted">
        <time datetime={pubDate.toISOString()}>{formatDate(pubDate)}</time>
        <span>&middot;</span>
        <span>{readingTime}</span>
        {updatedDate && (
          <>
            <span>&middot;</span>
            <span>Updated {formatDate(updatedDate)}</span>
          </>
        )}
      </div>
      {tags.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {tags.map((tag) => (
            <a href={`/tags/${tag}`} class="text-sm text-skin-accent hover:underline underline-offset-2">
              #{tag}
            </a>
          ))}
        </div>
      )}
    </header>

    {headings.length > 0 && (
      <aside class="mb-8 p-4 rounded border border-skin-line bg-skin-card">
        <TableOfContents headings={headings} />
      </aside>
    )}

    <div class="prose prose-lg max-w-none" data-pagefind-body>
      <slot />
    </div>

    <!-- Navigation -->
    {(prevPost || nextPost) && (
      <nav class="mt-12 pt-8 border-t border-skin-line flex flex-col sm:flex-row gap-4">
        {prevPost ? (
          <a href={`/blog/${prevPost.slug}`} class="flex-1 group">
            <span class="text-sm text-skin-muted">Previous</span>
            <p class="text-skin-base group-hover:text-skin-accent">{prevPost.title}</p>
          </a>
        ) : <div class="flex-1" />}
        {nextPost && (
          <a href={`/blog/${nextPost.slug}`} class="flex-1 text-right group">
            <span class="text-sm text-skin-muted">Next</span>
            <p class="text-skin-base group-hover:text-skin-accent">{nextPost.title}</p>
          </a>
        )}
      </nav>
    )}

  </article>

  <CodeCopy />
</BaseLayout>
