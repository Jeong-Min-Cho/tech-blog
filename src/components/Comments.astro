---
interface Props {
  pageId: string;
  pageTitle: string;
}

const { pageId, pageTitle } = Astro.props;
const appId = import.meta.env.PUBLIC_CUSDIS_APP_ID || 'demo';
---

<section class="mt-12 pt-8 border-t border-skin-line">
  <h2 class="text-lg font-medium text-skin-base mb-6">Comments</h2>
  <div
    id="cusdis_thread"
    data-host="https://cusdis.com"
    data-app-id={appId}
    data-page-id={pageId}
    data-page-url={Astro.url.href}
    data-page-title={pageTitle}
    data-theme="auto"
  />
</section>

<script>
  function initCusdis() {
    const el = document.getElementById('cusdis_thread');
    if (!el) return;

    // Set theme based on dark mode
    const isDark = document.documentElement.classList.contains('dark');
    el.setAttribute('data-theme', isDark ? 'dark' : 'light');

    // Load Cusdis script if not already loaded
    if (!document.getElementById('cusdis-script')) {
      const script = document.createElement('script');
      script.id = 'cusdis-script';
      script.src = 'https://cusdis.com/js/cusdis.es.js';
      script.async = true;
      script.onload = () => {
        // @ts-ignore
        if (window.CUSDIS) window.CUSDIS.initial();
      };
      document.body.appendChild(script);
    } else {
      // Reinitialize if script already loaded
      // @ts-ignore
      if (window.CUSDIS) window.CUSDIS.initial();
    }
  }

  // Listen for theme changes
  function observeTheme() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const el = document.getElementById('cusdis_thread');
          if (el) {
            const isDark = document.documentElement.classList.contains('dark');
            el.setAttribute('data-theme', isDark ? 'dark' : 'light');
            // @ts-ignore
            if (window.CUSDIS) window.CUSDIS.initial();
          }
        }
      });
    });
    observer.observe(document.documentElement, { attributes: true });
  }

  initCusdis();
  observeTheme();
  document.addEventListener('astro:after-swap', initCusdis);
</script>

<style is:global>
  /* Cusdis custom styling */
  #cusdis_thread {
    --cusdis-bg: rgb(var(--color-fill));
    --cusdis-text: rgb(var(--color-text-base));
    --cusdis-text-muted: rgb(var(--color-text-muted));
    --cusdis-border: rgb(var(--color-border));
    --cusdis-accent: rgb(var(--color-accent));
  }

  #cusdis_thread iframe {
    color-scheme: light dark;
  }

  /* Style the Cusdis container */
  [data-host="https://cusdis.com"] {
    font-family: inherit !important;
  }
</style>
